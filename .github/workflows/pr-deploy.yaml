name: PR Preview

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install Wrangler
        run: npm install -g wrangler

      - name: Deploy Preview with Wrangler
        id: deploy
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: |
          # Run deployment and capture output
          OUTPUT=$(wrangler pages deploy . \
            --project-name ${{ secrets.CLOUDFLARE_PAGES_PROJECT }} \
            --branch "pr-${{ github.event.number }}" 2>&1)
          
          echo "$OUTPUT"
          
          if [[ "$OUTPUT" == *"error"* ]]; then
            echo "Wrangler deployment failed."
            exit 1
          fi
          
          PREVIEW_URL=$(echo "$OUTPUT" | grep -oE "https://[a-zA-Z0-9.-]+\.pages\.dev")
          
          if [ -z "$PREVIEW_URL" ]; then
            echo "Failed to extract preview URL"
            exit 1
          fi
          
          echo "PREVIEW_URL=$PREVIEW_URL" >> $GITHUB_ENV
      - name: Comment preview URL on PR
        if: ${{ github.event_name == 'pull_request' }}
        uses: mshick/add-pr-comment@v2
        with:
          message: |
            ðŸš€ Cloudflare Pages preview deployed!

            ðŸ‘‰ **Preview URL**: ${{ env.PREVIEW_URL }}
