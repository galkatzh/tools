<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×‘×—×™×¨×ª ××™×§×•× ×™×¨×•×©×œ×™× - Jerusalem Location Picker</title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            height: 100vh;
            overflow: hidden;
        }

        #map {
            height: calc(100vh - 120px);
            width: 100%;
        }

        .controls {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }

        .controls h1 {
            color: white;
            font-size: 24px;
            margin-bottom: 15px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .button-group {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        button {
            background: white;
            color: #667eea;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            font-weight: 600;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .info-box {
            background: #f8f9fa;
            padding: 15px;
            margin: 10px 20px;
            border-radius: 8px;
            text-align: center;
            font-size: 14px;
            color: #495057;
            border-left: 4px solid #667eea;
        }

        .info-box.selected {
            background: #d4edda;
            border-left-color: #28a745;
            color: #155724;
        }

        .leaflet-popup-content-wrapper {
            border-radius: 8px;
        }

        .leaflet-popup-content {
            text-align: center;
            font-family: inherit;
        }

        .popup-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            margin-top: 10px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .popup-button:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
        }
    </style>
</head>
<body>
    <div class="controls">
        <h1>ğŸ—ºï¸ ×‘×—×™×¨×ª ××™×§×•× ×™×¨×•×©×œ×™× - Jerusalem Location Picker</h1>
        <div class="button-group">
            <button id="useLocationBtn">ğŸ“ ×”×©×ª××© ×‘××™×§×•× ×©×œ×™ / Use My Location</button>
            <button id="openSceneBtn" disabled>ğŸš€ ×¤×ª×— ×¡×¦× ×” ×ª×œ×ª-×××“×™×ª / Open 3D Scene</button>
        </div>
    </div>

    <div id="infoBox" class="info-box">
        ×œ×—×¥ ×¢×œ ×”××¤×” ×œ×‘×—×™×¨×ª ××™×§×•× ××• ×”×©×ª××© ×‘××™×§×•× ×”× ×•×›×—×™ ×©×œ×š<br>
        Click on the map to select a location or use your current location
    </div>

    <div id="map"></div>

    <!-- Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // Jerusalem center coordinates
        const JERUSALEM_CENTER = [31.7683, 35.2137];
        const DEFAULT_ZOOM = 13;
        const DEFAULT_Z = 1000;

        let map;
        let selectedMarker = null;
        let selectedCoords = null;

        // Initialize the map
        function initMap() {
            map = L.map('map').setView(JERUSALEM_CENTER, DEFAULT_ZOOM);

            // Add OpenStreetMap tile layer
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                maxZoom: 19
            }).addTo(map);

            // Add click event to map
            map.on('click', onMapClick);

            // Add a marker at Jerusalem center as reference
            L.marker(JERUSALEM_CENTER)
                .addTo(map)
                .bindPopup('<b>×™×¨×•×©×œ×™× / Jerusalem</b><br>Click anywhere on the map to select a location')
                .openPopup();
        }

        // Handle map click
        function onMapClick(e) {
            const lat = e.latlng.lat;
            const lng = e.latlng.lng;

            setSelectedLocation(lat, lng);
        }

        // Set selected location
        function setSelectedLocation(lat, lng) {
            selectedCoords = { lat, lng };

            // Remove previous marker if exists
            if (selectedMarker) {
                map.removeLayer(selectedMarker);
            }

            // Add new marker
            selectedMarker = L.marker([lat, lng])
                .addTo(map)
                .bindPopup(`
                    <div>
                        <strong>××™×§×•× × ×‘×—×¨ / Selected Location</strong><br>
                        <small>Lat: ${lat.toFixed(6)}<br>
                        Lng: ${lng.toFixed(6)}</small><br>
                        <button class="popup-button" onclick="openScene()">×¤×ª×— ×¡×¦× ×” / Open Scene</button>
                    </div>
                `)
                .openPopup();

            // Update info box
            const infoBox = document.getElementById('infoBox');
            infoBox.className = 'info-box selected';
            infoBox.innerHTML = `
                âœ… ××™×§×•× × ×‘×—×¨ / Location Selected<br>
                <small>Coordinates: ${lat.toFixed(6)}, ${lng.toFixed(6)}</small>
            `;

            // Enable the open scene button
            document.getElementById('openSceneBtn').disabled = false;
        }

        // Use geolocation
        async function useMyLocation() {
            if (!navigator.geolocation) {
                alert('Geolocation is not supported by your browser / ×”×“×¤×“×¤×Ÿ ×©×œ×š ×œ× ×ª×•××š ×‘××™×§×•× ×’×™××•×’×¨×¤×™');
                return;
            }

            // Check if we're in a secure context
            if (location.protocol !== 'https:' && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
                alert('âš ï¸ Location access requires HTTPS. Please access this page via HTTPS.\n\n×’×™×©×” ×œ××™×§×•× ×“×•×¨×©×ª HTTPS. ×× × ×’×© ×œ×“×£ ×–×” ×“×¨×š HTTPS.');
                return;
            }

            const infoBox = document.getElementById('infoBox');
            infoBox.className = 'info-box';
            infoBox.innerHTML = 'ğŸ” ×××ª×¨ ××ª ××™×§×•××š / Locating you...';

            // Geolocation options
            const options = {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 0
            };

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;

                    // Pan to user location
                    map.setView([lat, lng], 16);

                    // Set as selected location
                    setSelectedLocation(lat, lng);
                },
                (error) => {
                    let errorMsg = '×œ× × ×™×ª×Ÿ ×œ×§×‘×œ ××ª ×”××™×§×•× ×©×œ×š / Unable to get your location';
                    let detailMsg = '';

                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMsg = 'ğŸš« ×”×¨×©××” × ×“×—×ª×” / Permission denied';
                            detailMsg = '\n\nPlease enable location permissions in your browser settings:\n' +
                                       'â€¢ Chrome/Safari: Click the lock icon in the address bar\n' +
                                       'â€¢ Firefox: Click the shield icon\n' +
                                       'â€¢ Mobile: Check Settings > Safari/Chrome > Location Services\n\n' +
                                       '×× × ××¤×©×¨ ×”×¨×©××•×ª ××™×§×•× ×‘×”×’×“×¨×•×ª ×”×“×¤×“×¤×Ÿ ×©×œ×š';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMsg = 'ğŸ“ ××™×§×•× ×œ× ×–××™×Ÿ / Position unavailable';
                            detailMsg = '\n\nLocation information is unavailable. Please check:\n' +
                                       'â€¢ Location services are enabled on your device\n' +
                                       'â€¢ You have a GPS signal (if outdoors)\n\n' +
                                       '××™×“×¢ ××™×§×•× ××™× ×• ×–××™×Ÿ. ×× × ×‘×“×•×§ ×©×™×¨×•×ª×™ ××™×§×•× ×‘××›×©×™×¨×š';
                            break;
                        case error.TIMEOUT:
                            errorMsg = 'â±ï¸ ×ª× ×”×–××Ÿ / Request timeout';
                            detailMsg = '\n\nThe request timed out. Please try again.\n\n×”×‘×§×©×” ×¤×’×”. ×× × × ×¡×” ×©×•×‘.';
                            break;
                    }

                    alert(errorMsg + detailMsg);

                    infoBox.className = 'info-box';
                    infoBox.innerHTML = `
                        ×œ×—×¥ ×¢×œ ×”××¤×” ×œ×‘×—×™×¨×ª ××™×§×•× ××• ×”×©×ª××© ×‘××™×§×•× ×”× ×•×›×—×™ ×©×œ×š<br>
                        Click on the map to select a location or use your current location
                    `;
                },
                options
            );
        }

        // Open the 3D scene
        function openScene() {
            if (!selectedCoords) {
                alert('×× × ×‘×—×¨ ××™×§×•× ×ª×—×™×œ×” / Please select a location first');
                return;
            }

            const url = `https://oapgis.ofekonline.com/customscene/Jrs_Public/?locale=he&y=${selectedCoords.lat}&x=${selectedCoords.lng}&z=${DEFAULT_Z}`;
            window.open(url, '_blank');
        }

        // Event listeners
        document.getElementById('useLocationBtn').addEventListener('click', useMyLocation);
        document.getElementById('openSceneBtn').addEventListener('click', openScene);

        // Initialize map when page loads
        window.addEventListener('load', initMap);
    </script>
</body>
</html>
