<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Israel Real Estate Deals</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }
        h1 {
            text-align: center;
            margin-bottom: 20px;
            color: #333;
        }
        #map {
            height: 500px;
            width: 100%;
            margin-bottom: 20px;
            border: 2px solid #ddd;
            border-radius: 8px;
        }
        .instructions {
            background: #fff;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            background: #fff;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .loading.active {
            display: block;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .charts-container {
            display: none;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        .charts-container.active {
            display: grid;
        }
        .chart-wrapper {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .chart-wrapper h2 {
            margin-bottom: 15px;
            font-size: 18px;
            color: #333;
        }
        #tableContainer {
            display: none;
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow-x: auto;
        }
        #tableContainer.active {
            display: block;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background: #3498db;
            color: white;
            cursor: pointer;
            user-select: none;
            position: sticky;
            top: 0;
        }
        th:hover {
            background: #2980b9;
        }
        th::after {
            content: ' ⇅';
            opacity: 0.5;
        }
        th.sort-asc::after {
            content: ' ↑';
            opacity: 1;
        }
        th.sort-desc::after {
            content: ' ↓';
            opacity: 1;
        }
        tr:hover {
            background: #f5f5f5;
        }
        .summary {
            display: none;
            background: #fff;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .summary.active {
            display: block;
        }
        .summary h3 {
            margin-bottom: 10px;
            color: #333;
        }
        .comparison-mode-toggle {
            display: none;
            background: #fff;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
        }
        .comparison-mode-toggle.active {
            display: block;
        }
        .comparison-mode-toggle button {
            padding: 10px 20px;
            margin: 0 5px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
        }
        .comparison-mode-toggle button.selected {
            background: #3498db;
            color: white;
        }
        .comparison-mode-toggle button:not(.selected) {
            background: #ecf0f1;
            color: #333;
        }
        .comparison-mode-toggle button:hover {
            opacity: 0.8;
        }
        .comparison-instructions {
            display: none;
            background: #fffbcc;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
            border: 2px solid #f1c40f;
        }
        .comparison-instructions.active {
            display: block;
        }
        .comparison-summary {
            display: none;
            background: #fff;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .comparison-summary.active {
            display: block;
        }
        .comparison-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 15px;
        }
        .comparison-card {
            padding: 15px;
            border-radius: 8px;
            border: 2px solid;
        }
        .comparison-card.neighborhood1 {
            border-color: rgb(75, 192, 192);
            background: rgba(75, 192, 192, 0.05);
        }
        .comparison-card.neighborhood2 {
            border-color: rgb(255, 99, 132);
            background: rgba(255, 99, 132, 0.05);
        }
        .comparison-card h4 {
            margin-bottom: 10px;
            color: #333;
        }
        .comparison-card p {
            margin: 5px 0;
            font-size: 14px;
        }
        .filters {
            display: none;
            background: #fff;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .filters.active {
            display: block;
        }
        .filters h3 {
            margin-bottom: 15px;
            color: #333;
        }
        .filter-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        .filter-item {
            display: flex;
            flex-direction: column;
        }
        .filter-item label {
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        .filter-item input, .filter-item select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .filter-item select[multiple] {
            min-height: 100px;
        }
        .filter-actions {
            display: flex;
            gap: 10px;
        }
        .filter-actions button {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
        }
        .filter-actions button.apply {
            background: #3498db;
            color: white;
        }
        .filter-actions button.apply:hover {
            background: #2980b9;
        }
        .filter-actions button.reset {
            background: #95a5a6;
            color: white;
        }
        .filter-actions button.reset:hover {
            background: #7f8c8d;
        }
        @media (max-width: 768px) {
            .charts-container {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <h1>Israel Real Estate Deals Explorer</h1>

    <div class="instructions">
        <strong>Instructions:</strong> Click on any location on the map to view real estate deals for that area.
    </div>

    <div class="comparison-mode-toggle active" id="comparisonModeToggle">
        <button id="singleModeBtn" class="selected" onclick="switchToSingleMode()">Single Neighborhood</button>
        <button id="comparisonModeBtn" onclick="switchToComparisonMode()">Compare Neighborhoods</button>
    </div>

    <div class="comparison-instructions" id="comparisonInstructions">
        <strong>Comparison Mode:</strong> Click on the map to select <span id="neighborhoodSelectPrompt">the first neighborhood</span>.
        <span id="comparisonStatus"></span>
    </div>

    <div id="map"></div>

    <div class="loading" id="loading">
        <div class="spinner"></div>
        <p id="loadingText">Loading data...</p>
    </div>

    <div class="summary" id="summary"></div>

    <div class="comparison-summary" id="comparisonSummary">
        <h3>Neighborhood Comparison</h3>
        <div class="comparison-grid" id="comparisonGrid"></div>
    </div>

    <div class="filters" id="filters">
        <h3>Filters</h3>
        <div class="filter-group">
            <div class="filter-item">
                <label for="filterRoomsMin">Min Rooms:</label>
                <input type="number" id="filterRoomsMin" placeholder="e.g., 2" min="0" step="0.5">
            </div>
            <div class="filter-item">
                <label for="filterRoomsMax">Max Rooms:</label>
                <input type="number" id="filterRoomsMax" placeholder="e.g., 5" min="0" step="0.5">
            </div>
            <div class="filter-item">
                <label for="filterDateStart">Start Date:</label>
                <input type="date" id="filterDateStart">
            </div>
            <div class="filter-item">
                <label for="filterDateEnd">End Date:</label>
                <input type="date" id="filterDateEnd">
            </div>
            <div class="filter-item">
                <label for="filterStreet">Street Name:</label>
                <input type="text" id="filterStreet" placeholder="Search street...">
            </div>
            <div class="filter-item">
                <label for="filterDealNature">Deal Nature:</label>
                <select id="filterDealNature" multiple size="4">
                    <option value="">Loading...</option>
                </select>
            </div>
        </div>
        <div class="filter-actions">
            <button class="apply" onclick="applyFilters()">Apply Filters</button>
            <button class="reset" onclick="resetFilters()">Reset</button>
        </div>
    </div>

    <div class="charts-container" id="chartsContainer">
        <div class="chart-wrapper">
            <h2>Average Price per Square Meter Over Years</h2>
            <canvas id="pricePerSqmChart"></canvas>
        </div>
        <div class="chart-wrapper">
            <h2>Average Price per Room Over Years</h2>
            <canvas id="pricePerRoomChart"></canvas>
        </div>
    </div>

    <div id="tableContainer">
        <h2>Real Estate Deals (<span id="recordCount">0</span> records)</h2>
        <table id="dealsTable">
            <thead>
                <tr>
                    <th data-column="source" id="sourceHeader" style="display: none;">Source</th>
                    <th data-column="settlementNameHeb">Settlement</th>
                    <th data-column="streetNameHeb">Street</th>
                    <th data-column="houseNum">House #</th>
                    <th data-column="floorNo">Floor</th>
                    <th data-column="assetArea">Area (m²)</th>
                    <th data-column="assetRoomNum">Rooms</th>
                    <th data-column="dealAmount">Price (₪)</th>
                    <th data-column="pricePerSqm">₪/m²</th>
                    <th data-column="pricePerRoom">₪/Room</th>
                    <th data-column="propertyTypeDescription">Property Type</th>
                    <th data-column="dealNatureDescription">Deal Nature</th>
                    <th data-column="neighborhood">Neighborhood</th>
                    <th data-column="dealDate">Deal Date</th>
                </tr>
            </thead>
            <tbody id="dealsTableBody"></tbody>
        </table>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <script>
        // Initialize map centered on Israel
        const map = L.map('map').setView([31.5, 34.9], 8);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);

        let currentMarker = null;
        let pricePerSqmChart = null;
        let pricePerRoomChart = null;
        let allDeals = [];
        let filteredDeals = [];

        // Comparison mode variables
        let comparisonMode = false;
        let neighborhood1 = null;
        let neighborhood2 = null;
        let neighborhood1Marker = null;
        let neighborhood2Marker = null;

        // Convert WGS84 (lat/lon) to Web Mercator (EPSG:3857)
        function latLonToWebMercator(lat, lon) {
            const x = lon * 20037508.34 / 180;
            const y = Math.log(Math.tan((90 + lat) * Math.PI / 360)) / (Math.PI / 180) * 20037508.34 / 180;
            return { x, y };
        }

        // Sleep function
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // Format number with commas
        function formatNumber(num) {
            if (num === null || num === undefined) return 'N/A';
            return num.toLocaleString('en-US');
        }

        // Format date
        function formatDate(dateStr) {
            if (!dateStr) return 'N/A';
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
        }

        // Switch to single mode
        function switchToSingleMode() {
            comparisonMode = false;
            document.getElementById('singleModeBtn').classList.add('selected');
            document.getElementById('comparisonModeBtn').classList.remove('selected');
            document.getElementById('comparisonInstructions').classList.remove('active');
            document.getElementById('comparisonSummary').classList.remove('active');
            document.getElementById('sourceHeader').style.display = 'none';

            // Clear comparison data
            neighborhood1 = null;
            neighborhood2 = null;
            if (neighborhood1Marker) map.removeLayer(neighborhood1Marker);
            if (neighborhood2Marker) map.removeLayer(neighborhood2Marker);
            neighborhood1Marker = null;
            neighborhood2Marker = null;

            // Hide all data displays
            document.getElementById('chartsContainer').classList.remove('active');
            document.getElementById('filters').classList.remove('active');
            document.getElementById('tableContainer').classList.remove('active');
            document.getElementById('summary').classList.remove('active');
        }

        // Switch to comparison mode
        function switchToComparisonMode() {
            comparisonMode = true;
            document.getElementById('singleModeBtn').classList.remove('selected');
            document.getElementById('comparisonModeBtn').classList.add('selected');
            document.getElementById('comparisonInstructions').classList.add('active');
            document.getElementById('sourceHeader').style.display = '';

            // Clear single mode data
            allDeals = [];
            filteredDeals = [];
            if (currentMarker) map.removeLayer(currentMarker);
            currentMarker = null;

            // Reset comparison selections
            neighborhood1 = null;
            neighborhood2 = null;
            if (neighborhood1Marker) map.removeLayer(neighborhood1Marker);
            if (neighborhood2Marker) map.removeLayer(neighborhood2Marker);
            neighborhood1Marker = null;
            neighborhood2Marker = null;

            // Update prompt
            document.getElementById('neighborhoodSelectPrompt').textContent = 'the first neighborhood';
            document.getElementById('comparisonStatus').textContent = '';

            // Hide all data displays
            document.getElementById('chartsContainer').classList.remove('active');
            document.getElementById('filters').classList.remove('active');
            document.getElementById('tableContainer').classList.remove('active');
            document.getElementById('summary').classList.remove('active');
            document.getElementById('comparisonSummary').classList.remove('active');
        }

        // Fetch all deals data with pagination
        async function fetchAllDeals(polygonId) {
            const allData = [];
            let offset = 0;
            const limit = 1500;
            let iteration = 0;

            while (true) {
                iteration++;
                const url = `https://www.govmap.gov.il/api/real-estate/neighborhood-deals/${polygonId}?limit=${limit}&offset=${offset}&startDate=1998-01&endDate=2025-12`;

                document.getElementById('loadingText').textContent =
                    `Fetching data... (batch ${iteration}, ${allData.length} records so far)`;

                try {
                    const response = await fetch(url);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const result = await response.json();

                    if (result.data && result.data.length > 0) {
                        allData.push(...result.data);

                        if (result.data.length < limit) {
                            // Last batch
                            break;
                        }

                        offset += limit;

                        // Wait 3 seconds before next call
                        await sleep(3000);
                    } else {
                        break;
                    }
                } catch (error) {
                    console.error('Error fetching deals:', error);
                    alert(`Error fetching data: ${error.message}`);
                    break;
                }
            }

            return allData;
        }

        // Calculate standard deviation
        function calculateStdDev(values, mean) {
            if (values.length === 0) return 0;
            const squareDiffs = values.map(value => Math.pow(value - mean, 2));
            const avgSquareDiff = squareDiffs.reduce((sum, val) => sum + val, 0) / values.length;
            return Math.sqrt(avgSquareDiff);
        }

        // Helper function to process deals
        function processDealsData(deals) {
            const processedDeals = deals.map(deal => {
                const pricePerSqm = deal.assetArea ? deal.dealAmount / deal.assetArea : null;
                const pricePerRoom = deal.assetRoomNum ? deal.dealAmount / deal.assetRoomNum : null;
                const year = deal.dealDate ? new Date(deal.dealDate).getFullYear() : null;
                return { ...deal, pricePerSqm, pricePerRoom, year };
            }).filter(deal => deal.year !== null);

            const yearlyData = {};
            processedDeals.forEach(deal => {
                if (!yearlyData[deal.year]) {
                    yearlyData[deal.year] = {
                        pricePerSqmValues: [],
                        pricePerRoomValues: []
                    };
                }
                if (deal.pricePerSqm) {
                    yearlyData[deal.year].pricePerSqmValues.push(deal.pricePerSqm);
                }
                if (deal.pricePerRoom) {
                    yearlyData[deal.year].pricePerRoomValues.push(deal.pricePerRoom);
                }
            });

            return { processedDeals, yearlyData };
        }

        // Helper function to calculate yearly averages
        function calculateYearlyAverages(yearlyData) {
            const years = Object.keys(yearlyData).sort();
            const avgPricePerSqm = [];
            const avgPricePerRoom = [];

            years.forEach(year => {
                const data = yearlyData[year];

                if (data.pricePerSqmValues.length > 0) {
                    const avg = data.pricePerSqmValues.reduce((sum, val) => sum + val, 0) / data.pricePerSqmValues.length;
                    avgPricePerSqm.push(avg);
                } else {
                    avgPricePerSqm.push(null);
                }

                if (data.pricePerRoomValues.length > 0) {
                    const avg = data.pricePerRoomValues.reduce((sum, val) => sum + val, 0) / data.pricePerRoomValues.length;
                    avgPricePerRoom.push(avg);
                } else {
                    avgPricePerRoom.push(null);
                }
            });

            return { years, avgPricePerSqm, avgPricePerRoom };
        }

        // Process data and create charts (updated for comparison mode)
        function createCharts(deals, neighborhood2Deals = null) {
            // Destroy existing charts if they exist
            if (pricePerSqmChart) {
                pricePerSqmChart.destroy();
            }
            if (pricePerRoomChart) {
                pricePerRoomChart.destroy();
            }

            if (neighborhood2Deals) {
                // Comparison mode
                const n1Data = processDealsData(deals);
                const n2Data = processDealsData(neighborhood2Deals);

                // Get all unique years from both datasets
                const allYears = [...new Set([
                    ...Object.keys(n1Data.yearlyData),
                    ...Object.keys(n2Data.yearlyData)
                ])].sort();

                // Calculate averages for both neighborhoods
                const n1Averages = {};
                const n2Averages = {};

                allYears.forEach(year => {
                    const n1YearData = n1Data.yearlyData[year];
                    const n2YearData = n2Data.yearlyData[year];

                    n1Averages[year] = { pricePerSqm: null, pricePerRoom: null };
                    n2Averages[year] = { pricePerSqm: null, pricePerRoom: null };

                    if (n1YearData && n1YearData.pricePerSqmValues.length > 0) {
                        n1Averages[year].pricePerSqm = n1YearData.pricePerSqmValues.reduce((sum, val) => sum + val, 0) / n1YearData.pricePerSqmValues.length;
                    }
                    if (n1YearData && n1YearData.pricePerRoomValues.length > 0) {
                        n1Averages[year].pricePerRoom = n1YearData.pricePerRoomValues.reduce((sum, val) => sum + val, 0) / n1YearData.pricePerRoomValues.length;
                    }
                    if (n2YearData && n2YearData.pricePerSqmValues.length > 0) {
                        n2Averages[year].pricePerSqm = n2YearData.pricePerSqmValues.reduce((sum, val) => sum + val, 0) / n2YearData.pricePerSqmValues.length;
                    }
                    if (n2YearData && n2YearData.pricePerRoomValues.length > 0) {
                        n2Averages[year].pricePerRoom = n2YearData.pricePerRoomValues.reduce((sum, val) => sum + val, 0) / n2YearData.pricePerRoomValues.length;
                    }
                });

                const n1AvgPricePerSqm = allYears.map(year => n1Averages[year].pricePerSqm);
                const n1AvgPricePerRoom = allYears.map(year => n1Averages[year].pricePerRoom);
                const n2AvgPricePerSqm = allYears.map(year => n2Averages[year].pricePerSqm);
                const n2AvgPricePerRoom = allYears.map(year => n2Averages[year].pricePerRoom);

                // Create price per sqm chart
                const ctx1 = document.getElementById('pricePerSqmChart').getContext('2d');
                pricePerSqmChart = new Chart(ctx1, {
                    type: 'line',
                    data: {
                        labels: allYears,
                        datasets: [{
                            label: 'Neighborhood 1 - Avg ₪/m²',
                            data: n1AvgPricePerSqm,
                            borderColor: 'rgb(75, 192, 192)',
                            backgroundColor: 'rgba(75, 192, 192, 0.2)',
                            borderWidth: 2,
                            tension: 0.1,
                            pointRadius: 3,
                            pointHoverRadius: 5
                        }, {
                            label: 'Neighborhood 2 - Avg ₪/m²',
                            data: n2AvgPricePerSqm,
                            borderColor: 'rgb(255, 99, 132)',
                            backgroundColor: 'rgba(255, 99, 132, 0.2)',
                            borderWidth: 2,
                            tension: 0.1,
                            pointRadius: 3,
                            pointHoverRadius: 5
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                display: true
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return context.dataset.label + ': ₪' + context.parsed.y.toLocaleString('en-US', {
                                            minimumFractionDigits: 0,
                                            maximumFractionDigits: 0
                                        }) + '/m²';
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: false,
                                ticks: {
                                    callback: function(value) {
                                        return '₪' + value.toLocaleString();
                                    }
                                }
                            }
                        }
                    }
                });

                // Create price per room chart
                const ctx2 = document.getElementById('pricePerRoomChart').getContext('2d');
                pricePerRoomChart = new Chart(ctx2, {
                    type: 'line',
                    data: {
                        labels: allYears,
                        datasets: [{
                            label: 'Neighborhood 1 - Avg ₪/Room',
                            data: n1AvgPricePerRoom,
                            borderColor: 'rgb(75, 192, 192)',
                            backgroundColor: 'rgba(75, 192, 192, 0.2)',
                            borderWidth: 2,
                            tension: 0.1,
                            pointRadius: 3,
                            pointHoverRadius: 5
                        }, {
                            label: 'Neighborhood 2 - Avg ₪/Room',
                            data: n2AvgPricePerRoom,
                            borderColor: 'rgb(255, 99, 132)',
                            backgroundColor: 'rgba(255, 99, 132, 0.2)',
                            borderWidth: 2,
                            tension: 0.1,
                            pointRadius: 3,
                            pointHoverRadius: 5
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                display: true
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return context.dataset.label + ': ₪' + context.parsed.y.toLocaleString('en-US', {
                                            minimumFractionDigits: 0,
                                            maximumFractionDigits: 0
                                        }) + '/room';
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: false,
                                ticks: {
                                    callback: function(value) {
                                        return '₪' + value.toLocaleString();
                                    }
                                }
                            }
                        }
                    }
                });

                return { n1: n1Data.processedDeals, n2: n2Data.processedDeals };
            } else {
                // Single mode - keep original logic with std dev bounds
                const { processedDeals, yearlyData } = processDealsData(deals);
                const years = Object.keys(yearlyData).sort();
                const avgPricePerSqm = [];
                const stdDevPricePerSqm = [];
                const avgPricePerRoom = [];
                const stdDevPricePerRoom = [];

                years.forEach(year => {
                    const data = yearlyData[year];

                    if (data.pricePerSqmValues.length > 0) {
                        const avg = data.pricePerSqmValues.reduce((sum, val) => sum + val, 0) / data.pricePerSqmValues.length;
                        avgPricePerSqm.push(avg);
                        stdDevPricePerSqm.push(calculateStdDev(data.pricePerSqmValues, avg));
                    } else {
                        avgPricePerSqm.push(0);
                        stdDevPricePerSqm.push(0);
                    }

                    if (data.pricePerRoomValues.length > 0) {
                        const avg = data.pricePerRoomValues.reduce((sum, val) => sum + val, 0) / data.pricePerRoomValues.length;
                        avgPricePerRoom.push(avg);
                        stdDevPricePerRoom.push(calculateStdDev(data.pricePerRoomValues, avg));
                    } else {
                        avgPricePerRoom.push(0);
                        stdDevPricePerRoom.push(0);
                    }
                });

                const upperBoundSqm = avgPricePerSqm.map((avg, i) => avg + stdDevPricePerSqm[i]);
                const lowerBoundSqm = avgPricePerSqm.map((avg, i) => avg - stdDevPricePerSqm[i]);

                const ctx1 = document.getElementById('pricePerSqmChart').getContext('2d');
                pricePerSqmChart = new Chart(ctx1, {
                    type: 'line',
                    data: {
                        labels: years,
                        datasets: [{
                            label: 'Upper Bound (Avg + StdDev)',
                            data: upperBoundSqm,
                            borderColor: 'rgba(75, 192, 192, 0.3)',
                            backgroundColor: 'rgba(75, 192, 192, 0.1)',
                            borderWidth: 1,
                            borderDash: [5, 5],
                            fill: '+1',
                            tension: 0.1,
                            pointRadius: 0
                        }, {
                            label: 'Avg ₪/m²',
                            data: avgPricePerSqm,
                            borderColor: 'rgb(75, 192, 192)',
                            backgroundColor: 'rgba(75, 192, 192, 0.2)',
                            borderWidth: 2,
                            tension: 0.1,
                            fill: false,
                            pointRadius: 3,
                            pointHoverRadius: 5
                        }, {
                            label: 'Lower Bound (Avg - StdDev)',
                            data: lowerBoundSqm,
                            borderColor: 'rgba(75, 192, 192, 0.3)',
                            backgroundColor: 'rgba(75, 192, 192, 0.1)',
                            borderWidth: 1,
                            borderDash: [5, 5],
                            fill: false,
                            tension: 0.1,
                            pointRadius: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                display: true
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return '₪' + context.parsed.y.toLocaleString('en-US', {
                                            minimumFractionDigits: 0,
                                            maximumFractionDigits: 0
                                        }) + '/m²';
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: false,
                                ticks: {
                                    callback: function(value) {
                                        return '₪' + value.toLocaleString();
                                    }
                                }
                            }
                        }
                    }
                });

                const upperBoundRoom = avgPricePerRoom.map((avg, i) => avg + stdDevPricePerRoom[i]);
                const lowerBoundRoom = avgPricePerRoom.map((avg, i) => avg - stdDevPricePerRoom[i]);

                const ctx2 = document.getElementById('pricePerRoomChart').getContext('2d');
                pricePerRoomChart = new Chart(ctx2, {
                    type: 'line',
                    data: {
                        labels: years,
                        datasets: [{
                            label: 'Upper Bound (Avg + StdDev)',
                            data: upperBoundRoom,
                            borderColor: 'rgba(255, 99, 132, 0.3)',
                            backgroundColor: 'rgba(255, 99, 132, 0.1)',
                            borderWidth: 1,
                            borderDash: [5, 5],
                            fill: '+1',
                            tension: 0.1,
                            pointRadius: 0
                        }, {
                            label: 'Avg ₪/Room',
                            data: avgPricePerRoom,
                            borderColor: 'rgb(255, 99, 132)',
                            backgroundColor: 'rgba(255, 99, 132, 0.2)',
                            borderWidth: 2,
                            tension: 0.1,
                            fill: false,
                            pointRadius: 3,
                            pointHoverRadius: 5
                        }, {
                            label: 'Lower Bound (Avg - StdDev)',
                            data: lowerBoundRoom,
                            borderColor: 'rgba(255, 99, 132, 0.3)',
                            backgroundColor: 'rgba(255, 99, 132, 0.1)',
                            borderWidth: 1,
                            borderDash: [5, 5],
                            fill: false,
                            tension: 0.1,
                            pointRadius: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                display: true
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return '₪' + context.parsed.y.toLocaleString('en-US', {
                                            minimumFractionDigits: 0,
                                            maximumFractionDigits: 0
                                        }) + '/room';
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: false,
                                ticks: {
                                    callback: function(value) {
                                        return '₪' + value.toLocaleString();
                                    }
                                }
                            }
                        }
                    }
                });

                return processedDeals;
            }
        }

        // Create table (updated for comparison mode)
        function createTable(deals) {
            const tbody = document.getElementById('dealsTableBody');
            tbody.innerHTML = '';

            deals.forEach(deal => {
                const row = document.createElement('tr');
                const sourceCell = deal.source ? `<td style="background-color: ${deal.source === 'Neighborhood 1' ? 'rgba(75, 192, 192, 0.1)' : 'rgba(255, 99, 132, 0.1)'}; font-weight: bold;">${deal.source}</td>` : '';

                row.innerHTML = `
                    ${sourceCell}
                    <td>${deal.settlementNameHeb || 'N/A'}</td>
                    <td>${deal.streetNameHeb || 'N/A'}</td>
                    <td>${deal.houseNum || 'N/A'}</td>
                    <td>${deal.floorNo || 'N/A'}</td>
                    <td>${formatNumber(deal.assetArea)}</td>
                    <td>${deal.assetRoomNum || 'N/A'}</td>
                    <td>${formatNumber(deal.dealAmount)}</td>
                    <td>${deal.pricePerSqm ? formatNumber(Math.round(deal.pricePerSqm)) : 'N/A'}</td>
                    <td>${deal.pricePerRoom ? formatNumber(Math.round(deal.pricePerRoom)) : 'N/A'}</td>
                    <td>${deal.propertyTypeDescription || 'N/A'}</td>
                    <td>${deal.dealNatureDescription || 'N/A'}</td>
                    <td>${deal.neighborhood || 'N/A'}</td>
                    <td>${formatDate(deal.dealDate)}</td>
                `;
                tbody.appendChild(row);
            });

            document.getElementById('recordCount').textContent = deals.length;
        }

        // Sort table
        let sortColumn = null;
        let sortDirection = 'asc';

        function sortTable(column) {
            if (sortColumn === column) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortColumn = column;
                sortDirection = 'asc';
            }

            // Update header indicators
            document.querySelectorAll('th').forEach(th => {
                th.classList.remove('sort-asc', 'sort-desc');
            });
            const header = document.querySelector(`th[data-column="${column}"]`);
            header.classList.add(sortDirection === 'asc' ? 'sort-asc' : 'sort-desc');

            // Sort data (use filteredDeals if filters are active, otherwise use allDeals)
            const dataToSort = filteredDeals.length > 0 ? filteredDeals : allDeals;
            const sortedDeals = [...dataToSort].sort((a, b) => {
                let aVal = a[column];
                let bVal = b[column];

                // Handle null/undefined
                if (aVal === null || aVal === undefined) return 1;
                if (bVal === null || bVal === undefined) return -1;

                // Convert to numbers if possible
                if (!isNaN(aVal) && !isNaN(bVal)) {
                    aVal = parseFloat(aVal);
                    bVal = parseFloat(bVal);
                }

                if (aVal < bVal) return sortDirection === 'asc' ? -1 : 1;
                if (aVal > bVal) return sortDirection === 'asc' ? 1 : -1;
                return 0;
            });

            createTable(sortedDeals);
        }

        // Add click handlers to table headers
        document.querySelectorAll('th[data-column]').forEach(th => {
            th.addEventListener('click', () => {
                sortTable(th.dataset.column);
            });
        });

        // Create comparison summary
        function createComparisonSummary(n1Info, n1Deals, n2Info, n2Deals) {
            const grid = document.getElementById('comparisonGrid');

            // Calculate statistics for neighborhood 1
            const n1AvgPrice = n1Deals.reduce((sum, deal) => sum + (deal.dealAmount || 0), 0) / n1Deals.length;
            const n1AvgPricePerSqm = n1Deals.filter(d => d.pricePerSqm).reduce((sum, deal) => sum + deal.pricePerSqm, 0) / n1Deals.filter(d => d.pricePerSqm).length;
            const n1AvgPricePerRoom = n1Deals.filter(d => d.pricePerRoom).reduce((sum, deal) => sum + deal.pricePerRoom, 0) / n1Deals.filter(d => d.pricePerRoom).length;
            const n1AvgArea = n1Deals.filter(d => d.assetArea).reduce((sum, deal) => sum + deal.assetArea, 0) / n1Deals.filter(d => d.assetArea).length;
            const n1AvgRooms = n1Deals.filter(d => d.assetRoomNum).reduce((sum, deal) => sum + deal.assetRoomNum, 0) / n1Deals.filter(d => d.assetRoomNum).length;

            // Calculate statistics for neighborhood 2
            const n2AvgPrice = n2Deals.reduce((sum, deal) => sum + (deal.dealAmount || 0), 0) / n2Deals.length;
            const n2AvgPricePerSqm = n2Deals.filter(d => d.pricePerSqm).reduce((sum, deal) => sum + deal.pricePerSqm, 0) / n2Deals.filter(d => d.pricePerSqm).length;
            const n2AvgPricePerRoom = n2Deals.filter(d => d.pricePerRoom).reduce((sum, deal) => sum + deal.pricePerRoom, 0) / n2Deals.filter(d => d.pricePerRoom).length;
            const n2AvgArea = n2Deals.filter(d => d.assetArea).reduce((sum, deal) => sum + deal.assetArea, 0) / n2Deals.filter(d => d.assetArea).length;
            const n2AvgRooms = n2Deals.filter(d => d.assetRoomNum).reduce((sum, deal) => sum + deal.assetRoomNum, 0) / n2Deals.filter(d => d.assetRoomNum).length;

            grid.innerHTML = `
                <div class="comparison-card neighborhood1">
                    <h4>Neighborhood 1</h4>
                    <p><strong>Settlement:</strong> ${n1Info.settlementNameHeb || 'N/A'}</p>
                    <p><strong>Street:</strong> ${n1Info.streetNameHeb || 'N/A'}</p>
                    <p><strong>Total Deals:</strong> ${formatNumber(n1Deals.length)}</p>
                    <p><strong>Avg Price:</strong> ₪${formatNumber(Math.round(n1AvgPrice))}</p>
                    <p><strong>Avg ₪/m²:</strong> ₪${formatNumber(Math.round(n1AvgPricePerSqm))}</p>
                    <p><strong>Avg ₪/Room:</strong> ₪${formatNumber(Math.round(n1AvgPricePerRoom))}</p>
                    <p><strong>Avg Area:</strong> ${Math.round(n1AvgArea)} m²</p>
                    <p><strong>Avg Rooms:</strong> ${n1AvgRooms.toFixed(1)}</p>
                </div>
                <div class="comparison-card neighborhood2">
                    <h4>Neighborhood 2</h4>
                    <p><strong>Settlement:</strong> ${n2Info.settlementNameHeb || 'N/A'}</p>
                    <p><strong>Street:</strong> ${n2Info.streetNameHeb || 'N/A'}</p>
                    <p><strong>Total Deals:</strong> ${formatNumber(n2Deals.length)}</p>
                    <p><strong>Avg Price:</strong> ₪${formatNumber(Math.round(n2AvgPrice))}</p>
                    <p><strong>Avg ₪/m²:</strong> ₪${formatNumber(Math.round(n2AvgPricePerSqm))}</p>
                    <p><strong>Avg ₪/Room:</strong> ₪${formatNumber(Math.round(n2AvgPricePerRoom))}</p>
                    <p><strong>Avg Area:</strong> ${Math.round(n2AvgArea)} m²</p>
                    <p><strong>Avg Rooms:</strong> ${n2AvgRooms.toFixed(1)}</p>
                </div>
            `;
        }

        // Populate deal nature filter options
        function populateDealNatureFilter(deals) {
            const dealNatureSelect = document.getElementById('filterDealNature');

            // Get unique deal nature values
            const uniqueDealNatures = [...new Set(
                deals
                    .map(deal => deal.dealNatureDescription)
                    .filter(nature => nature) // Remove null/undefined
            )].sort();

            // Clear existing options
            dealNatureSelect.innerHTML = '';

            // Add options
            uniqueDealNatures.forEach(nature => {
                const option = document.createElement('option');
                option.value = nature;
                option.textContent = nature;
                dealNatureSelect.appendChild(option);
            });
        }

        // Filter functions
        function applyFilters() {
            const roomsMin = document.getElementById('filterRoomsMin').value;
            const roomsMax = document.getElementById('filterRoomsMax').value;
            const dateStart = document.getElementById('filterDateStart').value;
            const dateEnd = document.getElementById('filterDateEnd').value;
            const streetName = document.getElementById('filterStreet').value.toLowerCase().trim();

            // Get selected deal nature values
            const dealNatureSelect = document.getElementById('filterDealNature');
            const selectedDealNatures = Array.from(dealNatureSelect.selectedOptions)
                .map(option => option.value)
                .filter(value => value !== ''); // Exclude empty values

            filteredDeals = allDeals.filter(deal => {
                // Filter by number of rooms
                if (roomsMin && deal.assetRoomNum < parseFloat(roomsMin)) {
                    return false;
                }
                if (roomsMax && deal.assetRoomNum > parseFloat(roomsMax)) {
                    return false;
                }

                // Filter by date
                if (dateStart || dateEnd) {
                    const dealDate = deal.dealDate ? new Date(deal.dealDate) : null;
                    if (!dealDate) return false;

                    if (dateStart) {
                        const startDate = new Date(dateStart);
                        if (dealDate < startDate) return false;
                    }
                    if (dateEnd) {
                        const endDate = new Date(dateEnd);
                        if (dealDate > endDate) return false;
                    }
                }

                // Filter by street name
                if (streetName && deal.streetNameHeb) {
                    if (!deal.streetNameHeb.toLowerCase().includes(streetName)) {
                        return false;
                    }
                }

                // Filter by deal nature
                if (selectedDealNatures.length > 0) {
                    if (!deal.dealNatureDescription || !selectedDealNatures.includes(deal.dealNatureDescription)) {
                        return false;
                    }
                }

                return true;
            });

            // Update the charts with filtered data
            createCharts(filteredDeals);

            // Update the table with filtered data
            createTable(filteredDeals);
        }

        function resetFilters() {
            // Clear all filter inputs
            document.getElementById('filterRoomsMin').value = '';
            document.getElementById('filterRoomsMax').value = '';
            document.getElementById('filterDateStart').value = '';
            document.getElementById('filterDateEnd').value = '';
            document.getElementById('filterStreet').value = '';

            // Clear deal nature selection
            const dealNatureSelect = document.getElementById('filterDealNature');
            Array.from(dealNatureSelect.options).forEach(option => option.selected = false);

            // Reset filtered deals to all deals
            filteredDeals = [...allDeals];

            // Update the charts with all data
            createCharts(filteredDeals);

            // Update the table
            createTable(filteredDeals);
        }

        // Handle map clicks (updated for comparison mode)
        map.on('click', async function(e) {
            const lat = e.latlng.lat;
            const lon = e.latlng.lng;

            if (!comparisonMode) {
                // SINGLE MODE
                // Add or update marker
                if (currentMarker) {
                    map.removeLayer(currentMarker);
                }
                currentMarker = L.marker([lat, lon]).addTo(map);

                // Convert to Web Mercator
                const coords = latLonToWebMercator(lat, lon);
                const randomNum = Math.random() * 10;

                // Show loading
                document.getElementById('loading').classList.add('active');
                document.getElementById('loadingText').textContent = 'Fetching location data...';
                document.getElementById('chartsContainer').classList.remove('active');
                document.getElementById('filters').classList.remove('active');
                document.getElementById('tableContainer').classList.remove('active');
                document.getElementById('summary').classList.remove('active');

                try {
                    // First API call
                    const url1 = `https://www.govmap.gov.il/api/real-estate/deals/${coords.x},${coords.y}/${randomNum}`;
                    const response1 = await fetch(url1);

                    if (!response1.ok) {
                        throw new Error(`HTTP error! status: ${response1.status}`);
                    }

                    const data1 = await response1.json();

                    if (!data1 || data1.length === 0) {
                        alert('No data found for this location. Try clicking on a different area.');
                        document.getElementById('loading').classList.remove('active');
                        return;
                    }

                    const polygonId = data1[0].polygon_id;
                    const locationInfo = data1[0];

                    // Fetch all deals
                    const deals = await fetchAllDeals(polygonId);

                    if (deals.length === 0) {
                        alert('No deals found for this area.');
                        document.getElementById('loading').classList.remove('active');
                        return;
                    }

                    // Process and display data
                    const processedDeals = createCharts(deals);
                    allDeals = processedDeals;
                    filteredDeals = [...processedDeals];
                    populateDealNatureFilter(processedDeals);
                    createTable(filteredDeals);

                    // Show summary
                    const summaryEl = document.getElementById('summary');
                    summaryEl.innerHTML = `
                        <h3>Location Information</h3>
                        <p><strong>Settlement:</strong> ${locationInfo.settlementNameHeb || 'N/A'}</p>
                        <p><strong>Street:</strong> ${locationInfo.streetNameHeb || 'N/A'}</p>
                        <p><strong>House Number:</strong> ${locationInfo.houseNum || 'N/A'}</p>
                        <p><strong>Total Deals:</strong> ${deals.length}</p>
                    `;

                    // Show all elements
                    document.getElementById('loading').classList.remove('active');
                    document.getElementById('summary').classList.add('active');
                    document.getElementById('chartsContainer').classList.add('active');
                    document.getElementById('filters').classList.add('active');
                    document.getElementById('tableContainer').classList.add('active');

                } catch (error) {
                    console.error('Error:', error);
                    alert(`Error: ${error.message}`);
                    document.getElementById('loading').classList.remove('active');
                }
            } else {
                // COMPARISON MODE
                const coords = latLonToWebMercator(lat, lon);
                const randomNum = Math.random() * 10;

                // Show loading
                document.getElementById('loading').classList.add('active');
                document.getElementById('loadingText').textContent = 'Fetching location data...';

                try {
                    // First API call
                    const url1 = `https://www.govmap.gov.il/api/real-estate/deals/${coords.x},${coords.y}/${randomNum}`;
                    const response1 = await fetch(url1);

                    if (!response1.ok) {
                        throw new Error(`HTTP error! status: ${response1.status}`);
                    }

                    const data1 = await response1.json();

                    if (!data1 || data1.length === 0) {
                        alert('No data found for this location. Try clicking on a different area.');
                        document.getElementById('loading').classList.remove('active');
                        return;
                    }

                    const polygonId = data1[0].polygon_id;
                    const locationInfo = data1[0];

                    // Fetch all deals
                    const deals = await fetchAllDeals(polygonId);

                    if (deals.length === 0) {
                        alert('No deals found for this area.');
                        document.getElementById('loading').classList.remove('active');
                        return;
                    }

                    if (!neighborhood1) {
                        // First neighborhood selection
                        neighborhood1 = {
                            info: locationInfo,
                            deals: deals
                        };

                        // Add marker with cyan color
                        if (neighborhood1Marker) {
                            map.removeLayer(neighborhood1Marker);
                        }
                        const cyanIcon = L.icon({
                            iconUrl: 'data:image/svg+xml;base64,' + btoa('<svg xmlns="http://www.w3.org/2000/svg" width="25" height="41" viewBox="0 0 25 41"><path fill="rgb(75, 192, 192)" d="M12.5 0C5.6 0 0 5.6 0 12.5c0 9.4 12.5 28.5 12.5 28.5S25 21.9 25 12.5C25 5.6 19.4 0 12.5 0z"/><circle fill="white" cx="12.5" cy="12.5" r="7"/></svg>'),
                            iconSize: [25, 41],
                            iconAnchor: [12, 41]
                        });
                        neighborhood1Marker = L.marker([lat, lon], { icon: cyanIcon }).addTo(map);

                        // Update UI
                        document.getElementById('neighborhoodSelectPrompt').textContent = 'the second neighborhood';
                        document.getElementById('comparisonStatus').innerHTML = '<br><strong>Neighborhood 1 selected:</strong> ' + (locationInfo.settlementNameHeb || 'N/A');
                        document.getElementById('loading').classList.remove('active');

                    } else if (!neighborhood2) {
                        // Second neighborhood selection
                        neighborhood2 = {
                            info: locationInfo,
                            deals: deals
                        };

                        // Add marker with pink color
                        if (neighborhood2Marker) {
                            map.removeLayer(neighborhood2Marker);
                        }
                        const pinkIcon = L.icon({
                            iconUrl: 'data:image/svg+xml;base64,' + btoa('<svg xmlns="http://www.w3.org/2000/svg" width="25" height="41" viewBox="0 0 25 41"><path fill="rgb(255, 99, 132)" d="M12.5 0C5.6 0 0 5.6 0 12.5c0 9.4 12.5 28.5 12.5 28.5S25 21.9 25 12.5C25 5.6 19.4 0 12.5 0z"/><circle fill="white" cx="12.5" cy="12.5" r="7"/></svg>'),
                            iconSize: [25, 41],
                            iconAnchor: [12, 41]
                        });
                        neighborhood2Marker = L.marker([lat, lon], { icon: pinkIcon }).addTo(map);

                        // Process and display comparison
                        const chartsResult = createCharts(neighborhood1.deals, neighborhood2.deals);

                        // Add source property to deals for table display
                        const n1DealsWithSource = chartsResult.n1.map(deal => ({ ...deal, source: 'Neighborhood 1' }));
                        const n2DealsWithSource = chartsResult.n2.map(deal => ({ ...deal, source: 'Neighborhood 2' }));
                        const combinedDeals = [...n1DealsWithSource, ...n2DealsWithSource];

                        allDeals = combinedDeals;
                        filteredDeals = [...combinedDeals];
                        createTable(combinedDeals);
                        createComparisonSummary(neighborhood1.info, chartsResult.n1, neighborhood2.info, chartsResult.n2);

                        // Update UI
                        document.getElementById('loading').classList.remove('active');
                        document.getElementById('comparisonSummary').classList.add('active');
                        document.getElementById('chartsContainer').classList.add('active');
                        document.getElementById('tableContainer').classList.add('active');
                        document.getElementById('comparisonStatus').innerHTML = '<br><strong>Comparison ready!</strong> Click "Single Neighborhood" mode to reset.';
                    } else {
                        // Both neighborhoods already selected
                        alert('Both neighborhoods are already selected. Switch to "Single Neighborhood" mode to reset.');
                        document.getElementById('loading').classList.remove('active');
                    }

                } catch (error) {
                    console.error('Error:', error);
                    alert(`Error: ${error.message}`);
                    document.getElementById('loading').classList.remove('active');
                }
            }
        });
    </script>
</body>
</html>
